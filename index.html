<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Musik-Master 12.6 (Fix: Sound)</title>
    <style>
        /* --- BASIS STYLES --- */
        :root {
            --primary: #6c5ce7; --secondary: #a29bfe; --accent: #00cec9;
            --bg: #dfe6e9; --surface: #ffffff; --error: #ff7675;
            --success: #00b894; --text: #2d3436; --fire: #e17055;
            --gold: #ffd700;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: var(--text); user-select: none;
            overflow: hidden;
        }
        .app-container {
            background-color: var(--surface); padding: 2rem; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); text-align: center;
            max-width: 750px; width: 90%; position: relative; transition: all 0.3s ease;
            max-height: 95vh; overflow-y: auto; z-index: 10; border: 4px solid transparent;
        }
        
        /* GOLDEN ROUND STYLES */
        .app-container.golden-mode {
            border-color: var(--gold);
            box-shadow: 0 0 30px var(--gold);
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 20px var(--gold); }
            50% { box-shadow: 0 0 40px var(--gold); transform: scale(1.01); }
            100% { box-shadow: 0 0 20px var(--gold); }
        }
        .golden-badge {
            background-color: var(--gold); color: #fff; padding: 5px 15px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 10px; display: inline-block; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            animation: pop 0.5s;
        }

        h1 { margin-top: 0; color: var(--primary); }
        h2 { color: var(--text); }
        .screen { display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- DASHBOARD --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .dash-card {
            background: var(--bg); padding: 20px; border-radius: 20px;
            cursor: pointer; transition: transform 0.2s, background 0.2s;
            border: 2px solid transparent; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 10px;
        }
        .dash-card:hover { transform: translateY(-5px); background: #fff; border-color: var(--primary); }
        .dash-icon { font-size: 3rem; }
        .dash-title { font-weight: bold; font-size: 1.2rem; }

        /* --- UI ELEMENTE --- */
        .menu-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .btn-menu { padding: 18px; font-size: 1.2rem; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; color: white; transition: transform 0.2s, filter 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-menu:hover { transform: translateY(-3px); filter: brightness(1.1); }
        .btn-easy { background-color: var(--success); }
        .btn-medium { background-color: var(--primary); }
        .btn-hard { background-color: var(--error); }
        .btn-rhythm { background-color: var(--fire); }
        
        /* HEADER mit Combo & Lives */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.2rem; font-weight: 800; height: 40px;}
        .back-btn { background: none; border: 2px solid var(--text); padding: 5px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold; color: var(--text); transition: all 0.2s; }
        .back-btn:hover { background: var(--text); color: white; }
        
        .status-box { display: flex; gap: 15px; align-items: center; }
        .lives { color: var(--error); letter-spacing: 2px; font-size: 1.5rem; }

        .score-container { text-align: right; }
        .score { color: var(--primary); }
        .combo-display { font-size: 0.9rem; color: var(--fire); height: 20px; opacity: 0; transition: opacity 0.2s; }
        .combo-display.active { opacity: 1; font-weight: bold; animation: pop 0.3s; }

        /* --- VISUAL DISPLAY (Notenblatt & Bilder) --- */
        .sheet-music { background: #fff; border: 3px solid var(--text); border-radius: 15px; margin-bottom: 25px; height: 220px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .sheet-music.interactive { cursor: none; }
        .sheet-music.interactive:hover { border-color: var(--primary); }
        
        /* Spezielle Anpassung f√ºr Klavier-Modus */
        #piano-screen .sheet-music { height: 160px; max-width: 400px; margin-left: auto; margin-right: auto; }

        /* SVG f√ºr Noten */
        svg#staff, svg#piano-staff { width: 100%; height: 100%; display: block; }
        .acc-text { font-family: 'Times New Roman', serif; dominant-baseline: central; text-anchor: end; pointer-events: none; }
        
        /* Bild f√ºr Rhythmus */
        #rhythm-image { max-height: 90%; max-width: 90%; object-fit: contain; display: none; }

        /* --- GAME INPUTS --- */
        .options-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .options-grid.easy-mode { grid-template-columns: repeat(2, 1fr); }
        .options-grid.rhythm-mode { grid-template-columns: repeat(3, 1fr); }

        .game-btn { background-color: var(--bg); border: none; padding: 15px 5px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; color: var(--text); cursor: pointer; transition: transform 0.1s, background-color 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); word-wrap: break-word;}
        .game-btn:hover { transform: translateY(-2px); background-color: var(--secondary); color: white; }
        .game-btn.correct { background-color: var(--success) !important; color: white !important; animation: pop 0.3s; }
        .game-btn.wrong { background-color: var(--error) !important; color: white !important; animation: shake 0.4s; }
        
        .place-controls { display: flex; justify-content: center; gap: 20px; align-items: center; margin-bottom: 15px; }
        .acc-toggle { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--bg); background: white; font-size: 1.5rem; font-family: 'Times New Roman', serif; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .acc-toggle.selected { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); }
        .target-note-display { font-size: 2rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; }

        /* --- HARD MODE INPUT --- */
        .input-area { display: flex; gap: 10px; justify-content: center; }
        #answer-input { padding: 15px; font-size: 1.2rem; border: 2px solid var(--bg); border-radius: 10px; width: 60%; text-align: center; outline: none; transition: border-color 0.3s; }
        #submit-btn { padding: 0 25px; background-color: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        
        .feedback-msg { height: 20px; margin-top: 10px; font-weight: bold; color: var(--error); }
        
        /* --- PIANO --- */
        .piano-container { display: flex; justify-content: center; position: relative; height: 180px; margin-top: 20px; background: #333; padding: 10px; border-radius: 0 0 15px 15px; box-shadow: inset 0 5px 10px rgba(0,0,0,0.5); }
        .key { position: relative; cursor: pointer; user-select: none; border-radius: 0 0 5px 5px; transition: background 0.1s; }
        .key.white { width: 40px; height: 100%; background: white; margin: 0 2px; box-shadow: 0 5px 5px rgba(0,0,0,0.2); z-index: 1; }
        .key.white:active, .key.white.active { background: #eee; transform: translateY(2px); }
        .key.black { width: 28px; height: 60%; background: #222; position: absolute; top: 0; z-index: 2; box-shadow: 0 3px 5px rgba(0,0,0,0.3); }
        .key.black:active, .key.black.active { background: #000; transform: translateY(2px); }

        /* --- ANIMATIONS & OVERLAYS --- */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        @keyframes pop { 50% { transform: scale(1.15); } }
        
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); border-radius: 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .overlay.visible { visibility: visible; opacity: 1; }
        .restart-btn { background-color: var(--text); color: white; margin-top: 20px; padding: 15px 40px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; }
        
        /* THEORIE STYLES */
        .theory-content { text-align: left; line-height: 1.6; }
        .theory-section { margin-bottom: 30px; }
        .theory-box { background: #f1f2f6; border-left: 5px solid var(--accent); padding: 15px; margin: 10px 0; border-radius: 0 10px 10px 0; }
        .mnemonic { font-weight: bold; color: var(--primary); font-size: 1.1em; display: block; margin-top: 5px; margin-bottom: 10px; text-align: center;}
        .highlight { color: var(--error); font-weight: bold; }
        
        /* SVG in Theorie */
        .theory-svg { width: 100%; height: 100px; display: block; margin: 10px 0; background: white; border-radius: 8px; border: 1px solid #ddd; }
        .theory-text { font-family: sans-serif; font-weight: bold; fill: var(--primary); dominant-baseline: central; text-anchor: middle; }

        /* KONFETTI CANVAS */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div id="main-app" class="app-container">
    
    <div id="dashboard-screen" class="screen active">
        <h1>üéµ Musik-Master</h1>
        <p>Hallo! Was m√∂chtest du heute machen?</p>
        <div class="dashboard-grid">
            <div class="dash-card" onclick="switchScreen('training-menu-screen')">
                <div class="dash-icon">üéÆ</div>
                <div class="dash-title">Training</div>
                <small>√úben & Spielen</small>
            </div>
            <div class="dash-card" onclick="startPianoMode()">
                <div class="dash-icon">üéπ</div>
                <div class="dash-title">Klavier</div>
                <small>Freies Spielen</small>
            </div>
            <div class="dash-card" onclick="switchScreen('theory-screen')">
                <div class="dash-icon">üìö</div>
                <div class="dash-title">Theorie</div>
                <small>Alles erkl√§rt</small>
            </div>
            <div class="dash-card" onclick="switchScreen('highscores-screen')">
                <div class="dash-icon">üèÜ</div>
                <div class="dash-title">Rekorde</div>
                <small>Deine Punkte</small>
            </div>
        </div>
    </div>

    <div id="training-menu-screen" class="screen">
        <header>
            <button class="back-btn" onclick="switchScreen('dashboard-screen')">‚¨Ö Zur√ºck</button>
            <span>√úbung w√§hlen</span>
            <div style="width:60px"></div>
        </header>
        <h2>Was willst du √ºben?</h2>
        <div class="menu-buttons">
            <button class="btn-menu btn-medium" onclick="selectGameType('read')">
                üëÅÔ∏è Noten lesen<br><span style="font-size:0.8rem; opacity:0.8">Sag mir, wie die Note hei√üt.</span>
            </button>
            <button class="btn-menu btn-accent" style="background-color: var(--accent)" onclick="selectGameType('place')">
                ‚úçÔ∏è Noten schreiben<br><span style="font-size:0.8rem; opacity:0.8">Zeichne die Note ins System.</span>
            </button>
            <button class="btn-menu btn-rhythm" onclick="selectGameType('rhythm')">
                ‚è±Ô∏è Notenwerte<br><span style="font-size:0.8rem; opacity:0.8">Erkennst du Ganze, Halbe & Pausen?</span>
            </button>
        </div>
    </div>

    <div id="difficulty-screen" class="screen">
        <header>
            <button class="back-btn" onclick="switchScreen('training-menu-screen')">‚¨Ö Zur√ºck</button>
            <span>Stufe</span>
            <div style="width:60px"></div>
        </header>
        <h2>W√§hle deine Stufe:</h2>
        <div class="menu-buttons">
            <button class="btn-menu btn-easy" onclick="initGame('easy')">üå± Einfach<br><span style="font-size:0.8rem; opacity:0.8" id="diff-desc-easy">Stammnoten (C-D-E...)</span></button>
            <button class="btn-menu btn-medium" onclick="initGame('medium')">üéµ Mittel<br><span style="font-size:0.8rem; opacity:0.8" id="diff-desc-medium">Mit Vorzeichen (Fis, Es...)</span></button>
            <button class="btn-menu btn-hard" onclick="initGame('hard')">üî• Schwierig<br><span style="font-size:0.8rem; opacity:0.8" id="diff-desc-hard">Profi-Modus!</span></button>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <header>
            <button class="back-btn" onclick="showGameOver(false)">‚ùå</button>
            
            <div class="status-box">
                <div class="lives" id="lives-display"></div>
            </div>

            <div class="score-container">
                <div class="score" id="score-display">0</div>
                <div class="combo-display" id="combo-display">üî• x2</div>
            </div>
        </header>
        
        <div id="golden-round-badge" class="golden-badge" style="display:none">‚ú® Goldene Runde ‚ú®</div>

        <div id="place-instruction" style="display:none; text-align:center;">
            <span>Suche Note:</span>
            <div class="target-note-display" id="target-note-name">Cis</div>
            <small style="opacity:0.7; display:block; margin-top:-5px; margin-bottom:10px">(Oktave egal)</small>
        </div>

        <div class="sheet-music" id="sheet-music-container" onclick="handleStaffClick(event)" onmousemove="handleStaffMove(event)" onmouseleave="handleStaffLeave()">
            <svg id="staff" viewBox="0 0 200 200">
                <g stroke="#2d3436" stroke-width="2">
                    <line x1="10" y1="60" x2="190" y2="60" />
                    <line x1="10" y1="80" x2="190" y2="80" />
                    <line x1="10" y1="100" x2="190" y2="100" />
                    <line x1="10" y1="120" x2="190" y2="120" />
                    <line x1="10" y1="140" x2="190" y2="140" />
                </g>
                <text x="15" y="135" font-size="85" font-family="serif">ùÑû</text>
                
                <g id="note-group">
                    <g id="ledger-lines"></g>
                    <ellipse id="note-head" cx="110" cy="100" rx="11" ry="8" transform="rotate(-15 110 100)" fill="#2d3436"/>
                    <line id="note-stem" x1="120" y1="100" x2="120" y2="50" stroke="#2d3436" stroke-width="2"/>
                    <text id="accidental" x="92" y="100" font-size="34" fill="#2d3436" class="acc-text">‚ôØ</text>
                </g>

                <g id="ghost-group" style="display:none; opacity: 0.5; pointer-events: none;">
                    <g id="ghost-ledgers"></g>
                    <ellipse id="ghost-head" cx="110" cy="100" rx="11" ry="8" transform="rotate(-15 110 100)" fill="#6c5ce7"/>
                    <text id="ghost-acc" x="92" y="100" font-size="34" fill="#6c5ce7" class="acc-text">‚ôØ</text>
                </g>
            </svg>
            
            <img id="rhythm-image" src="" alt="Notenwert">

            <button id="replay-sound-btn" onclick="playCurrentGameNote()" style="position:absolute; bottom:10px; right:10px; border:none; background:none; cursor:pointer; font-size:1.5rem">üîä</button>
        </div>

        <div id="place-controls-area" class="place-controls" style="display:none;">
            <div class="acc-toggle" id="btn-flat" onclick="selectAccidental('flat')">‚ô≠</div>
            <div class="acc-toggle selected" id="btn-natural" onclick="selectAccidental('natural')">‚ôÆ</div>
            <div class="acc-toggle" id="btn-sharp" onclick="selectAccidental('sharp')">‚ôØ</div>
        </div>

        <div id="interaction-area"></div>
        <div id="feedback-text" class="feedback-msg"></div>
    </div>

    <div id="theory-screen" class="screen">
        <header>
            <button class="back-btn" onclick="switchScreen('dashboard-screen')">‚¨Ö Zur√ºck</button>
            <span>Theorie</span>
            <div style="width:60px"></div>
        </header>
        <div class="theory-content">
            <div class="theory-section">
                <h3>1. Die Linien (E-G-H-D-F)</h3>
                <p>Noten, die genau <strong>auf</strong> einer Linie liegen.</p>
                <div class="theory-box">
                    <span class="mnemonic"><span class="highlight">E</span>ine <span class="highlight">G</span>ans <span class="highlight">H</span>at <span class="highlight">D</span>rei <span class="highlight">F</span>√º√üe</span>
                    <svg viewBox="0 0 200 120" class="theory-svg">
                        <g stroke="#999" stroke-width="2">
                            <line x1="10" y1="20" x2="190" y2="20" />
                            <line x1="10" y1="40" x2="190" y2="40" />
                            <line x1="10" y1="60" x2="190" y2="60" />
                            <line x1="10" y1="80" x2="190" y2="80" />
                            <line x1="10" y1="100" x2="190" y2="100" />
                        </g>
                        <text x="30" y="100" class="theory-text">E</text>
                        <text x="60" y="80" class="theory-text">G</text>
                        <text x="90" y="60" class="theory-text">H</text>
                        <text x="120" y="40" class="theory-text">D</text>
                        <text x="150" y="20" class="theory-text">F</text>
                    </svg>
                </div>
            </div>

            <div class="theory-section">
                <h3>2. Die Zwischenr√§ume (F-A-C-E)</h3>
                <p>Noten, die <strong>zwischen</strong> den Linien liegen (wie das englische Wort f√ºr Gesicht).</p>
                <div class="theory-box">
                    <span class="mnemonic"><span class="highlight">F</span> - <span class="highlight">A</span> - <span class="highlight">C</span> - <span class="highlight">E</span></span>
                    <svg viewBox="0 0 200 120" class="theory-svg">
                        <g stroke="#999" stroke-width="2">
                            <line x1="10" y1="20" x2="190" y2="20" />
                            <line x1="10" y1="40" x2="190" y2="40" />
                            <line x1="10" y1="60" x2="190" y2="60" />
                            <line x1="10" y1="80" x2="190" y2="80" />
                            <line x1="10" y1="100" x2="190" y2="100" />
                        </g>
                        <text x="45" y="90" class="theory-text">F</text>
                        <text x="75" y="70" class="theory-text">A</text>
                        <text x="105" y="50" class="theory-text">C</text>
                        <text x="135" y="30" class="theory-text">E</text>
                    </svg>
                </div>
            </div>

            <div class="theory-section">
                <h3>3. Vorzeichen (# und b)</h3>
                <div class="theory-box">
                    <h4>‚ôØ Das Kreuz (Sharp)</h4>
                    <p>Macht die Note h√∂her. Man h√§ngt ein <strong>-is</strong> an den Namen.</p>
                    <ul>
                        <li>C ‚ûù <strong>Cis</strong></li>
                        <li>F ‚ûù <strong>Fis</strong></li>
                        <li>G ‚ûù <strong>Gis</strong></li>
                    </ul>
                </div>
                <div class="theory-box">
                    <h4>‚ô≠ Das B-Vorzeichen (Flat)</h4>
                    <p>Macht die Note tiefer. Man h√§ngt ein <strong>-es</strong> an.</p>
                    <ul>
                        <li>D ‚ûù <strong>Des</strong></li>
                        <li>G ‚ûù <strong>Ges</strong></li>
                    </ul>
                    <p style="color:var(--error); font-weight:bold; font-size:0.9rem">‚ö†Ô∏è Ausnahmen:</p>
                    <ul>
                        <li>H ‚ûù <strong>B</strong> (Wichtig!)</li>
                        <li>E ‚ûù <strong>Es</strong> (nicht Ees)</li>
                        <li>A ‚ûù <strong>As</strong> (nicht Aes)</li>
                    </ul>
                </div>
            </div>

            <div class="theory-section">
                <h3>4. Notenwerte</h3>
                <div class="theory-box">
                    <ul>
                        <li><strong>Ganze Note:</strong> 4 Schl√§ge (o)</li>
                        <li><strong>Halbe Note:</strong> 2 Schl√§ge (Hals dran)</li>
                        <li><strong>Viertel Note:</strong> 1 Schlag (Ausgemalt)</li>
                        <li><strong>Achtel Note:</strong> 1/2 Schlag (F√§hnchen)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="piano-screen" class="screen">
        <header>
            <button class="back-btn" onclick="switchScreen('dashboard-screen')">üè† Men√º</button>
            <span>Freies Spiel</span>
            <div style="width:60px"></div>
        </header>
        <div class="sheet-music">
            <svg id="piano-staff" viewBox="0 0 200 200">
                <g stroke="#2d3436" stroke-width="2">
                    <line x1="10" y1="60" x2="190" y2="60" />
                    <line x1="10" y1="80" x2="190" y2="80" />
                    <line x1="10" y1="100" x2="190" y2="100" />
                    <line x1="10" y1="120" x2="190" y2="120" />
                    <line x1="10" y1="140" x2="190" y2="140" />
                </g>
                <text x="15" y="135" font-size="85" font-family="serif">ùÑû</text>
                <g id="piano-note-group" style="display:none">
                    <g id="piano-ledgers"></g>
                    <ellipse id="piano-head" cx="110" cy="100" rx="11" ry="8" transform="rotate(-15 110 100)" fill="#2d3436"/>
                    <line id="piano-stem" x1="120" y1="100" x2="120" y2="50" stroke="#2d3436" stroke-width="2"/>
                    <text id="piano-acc" x="90" y="100" font-size="34" fill="#2d3436" class="acc-text">‚ôØ</text>
                </g>
            </svg>
            <div id="piano-note-name" style="position:absolute; top:10px; right:20px; font-size:2rem; font-weight:bold; color:var(--primary)"></div>
        </div>
        <div id="piano-keyboard" class="piano-container"></div>
    </div>

    <div id="highscores-screen" class="screen">
        <header>
            <button class="back-btn" onclick="switchScreen('dashboard-screen')">‚¨Ö Zur√ºck</button>
            <span>Rekorde</span>
            <div style="width:60px"></div>
        </header>
        <ul id="score-list-ul" style="list-style: none; padding: 0;"></ul>
    </div>

    <div class="overlay" id="game-over">
        <h2 id="overlay-title">Verloren!</h2>
        <p>Punkte: <strong id="final-score" style="font-size:1.5rem">0</strong></p>
        <button class="restart-btn" onclick="switchScreen('dashboard-screen')">Zum Hauptmen√º</button>
        <button class="restart-btn" style="background-color: var(--primary); margin-top:10px" onclick="initGame(gameState.difficulty)">Nochmal spielen</button>
    </div>

</div>

<script>
    /* --- AUDIO ENGINE --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, duration = 0.5) {
        if (!freq) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = 'triangle'; osc.frequency.value = freq;
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }
    
    function playCurrentGameNote() {
        if (!gameState.currentNote) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playTone(getFrequencyForNote(gameState.currentNote), 0.5);
    }

    /* --- DATA --- */
    const allBaseNotes = [
        { name: "G", y: 190 }, { name: "A", y: 180 }, { name: "H", y: 170 }, { name: "C", y: 160 }, 
        { name: "D", y: 150 }, { name: "E", y: 140 }, { name: "F", y: 130 }, { name: "G", y: 120 }, 
        { name: "A", y: 110 }, { name: "H", y: 100 }, { name: "C", y: 90 },  { name: "D", y: 80 },
        { name: "E", y: 70 },  { name: "F", y: 60 },  { name: "G", y: 50 },  { name: "A", y: 40 },  
        { name: "H", y: 30 },  { name: "C", y: 20 }
    ];
    const accidentals = [{ symbol: "", type: "natural" }, { symbol: "‚ôØ", type: "sharp" }, { symbol: "‚ô≠", type: "flat" }];

    // RHYTHMUS DATEN
    const rhythmData = [
        { file: "ganze_note", name: "Ganze Note", type: "note" },
        { file: "halbe_note", name: "Halbe Note", type: "note" },
        { file: "viertel_note", name: "Viertel Note", type: "note" },
        { file: "achtel_note", name: "Achtel Note", type: "note" },
        { file: "achtel_paar", name: "Achtel Paar", type: "note" },
        { file: "ganze_pause", name: "Ganze Pause", type: "rest" },
        { file: "halbe_pause", name: "Halbe Pause", type: "rest" },
        { file: "viertel_pause", name: "Viertel Pause", type: "rest" },
        { file: "achtel_pause", name: "Achtel Pause", type: "rest" }
    ];

    /* --- STATE --- */
    let gameState = {
        score: 0,
        combo: 0,
        lives: 3,
        difficulty: 'medium',
        gameType: 'read',
        currentNote: null,
        isAnswering: false,
        selectedPlaceAccidental: 'natural',
        // Golden Round State
        roundsPlayed: 0,
        nextGoldenRound: 0,
        isGoldenRound: false
    };
    let highscores = JSON.parse(localStorage.getItem('musicScores')) || [];

    /* --- UI REF --- */
    const ui = {
        app: document.getElementById('main-app'),
        lives: document.getElementById('lives-display'),
        score: document.getElementById('score-display'),
        combo: document.getElementById('combo-display'),
        goldenBadge: document.getElementById('golden-round-badge'),
        interaction: document.getElementById('interaction-area'),
        feedback: document.getElementById('feedback-text'),
        overlay: document.getElementById('game-over'),
        overlayTitle: document.getElementById('overlay-title'),
        finalScore: document.getElementById('final-score'),
        staffSvg: document.getElementById('staff'),
        rhythmImage: document.getElementById('rhythm-image'),
        sheetContainer: document.getElementById('sheet-music-container'),
        noteGroup: document.getElementById('note-group'), head: document.getElementById('note-head'), stem: document.getElementById('note-stem'), acc: document.getElementById('accidental'), ledgers: document.getElementById('ledger-lines'),
        ghostGroup: document.getElementById('ghost-group'), ghostHead: document.getElementById('ghost-head'), ghostAcc: document.getElementById('ghost-acc'), ghostLedgers: document.getElementById('ghost-ledgers'),
        replayBtn: document.getElementById('replay-sound-btn'),
        placeInstruction: document.getElementById('place-instruction'), targetNoteName: document.getElementById('target-note-name'), placeControls: document.getElementById('place-controls-area'),
        accBtns: { natural: document.getElementById('btn-natural'), sharp: document.getElementById('btn-sharp'), flat: document.getElementById('btn-flat') },
        pHead: document.getElementById('piano-head'), pStem: document.getElementById('piano-stem'), pAcc: document.getElementById('piano-acc'), pLedgers: document.getElementById('piano-ledgers'), pGroup: document.getElementById('piano-note-group'), pName: document.getElementById('piano-note-name'), scoreList: document.getElementById('score-list-ul'),
        // Diff descriptions
        descEasy: document.getElementById('diff-desc-easy'), descMedium: document.getElementById('diff-desc-medium'), descHard: document.getElementById('diff-desc-hard')
    };

    /* --- NAVIGATION --- */
    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        ui.overlay.classList.remove('visible');
        // Reset Golden Mode visuals when leaving game
        if(screenId !== 'game-screen') ui.app.classList.remove('golden-mode');
        if(screenId === 'highscores-screen') updateHighscoreList();
    }
    
    function selectGameType(type) {
        gameState.gameType = type;
        if (type === 'rhythm') {
            ui.descEasy.textContent = "Nur Noten";
            ui.descMedium.textContent = "Nur Noten (Schneller?)";
            ui.descHard.textContent = "Noten & Pausen";
        } else {
            ui.descEasy.textContent = "Stammnoten (C-D-E...)";
            ui.descMedium.textContent = "Mit Vorzeichen (Fis, Es...)";
            ui.descHard.textContent = "Profi-Modus!";
        }
        switchScreen('difficulty-screen');
    }

    function startPianoMode() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        switchScreen('piano-screen');
        initPiano();
    }

    /* --- GAME INIT --- */
    function initGame(level) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        gameState.difficulty = level;
        gameState.score = 0;
        gameState.combo = 0;
        gameState.lives = 3;
        gameState.isAnswering = false;
        gameState.currentNote = null; 
        
        // Init Golden Round
        gameState.roundsPlayed = 0;
        gameState.nextGoldenRound = Math.floor(Math.random() * 11) + 10; // 10-20
        gameState.isGoldenRound = false;

        switchScreen('game-screen');
        ui.feedback.textContent = "";
        ui.lives.style.display = 'block';

        // Type specific setup
        ui.placeInstruction.style.display = "none"; 
        ui.placeControls.style.display = "none";
        ui.ghostGroup.style.display = "none"; 

        if (gameState.gameType === 'read') {
            ui.staffSvg.style.display = "block";
            ui.rhythmImage.style.display = "none";
            ui.sheetContainer.classList.remove('interactive'); 
            ui.replayBtn.style.display = "block";
        } 
        else if (gameState.gameType === 'place') {
            ui.staffSvg.style.display = "block";
            ui.rhythmImage.style.display = "none";
            ui.placeInstruction.style.display = "block"; 
            ui.placeControls.style.display = "flex";
            ui.sheetContainer.classList.add('interactive'); 
            ui.replayBtn.style.display = "none";
            selectAccidental('natural');
        }
        else if (gameState.gameType === 'rhythm') {
            ui.staffSvg.style.display = "none";
            ui.rhythmImage.style.display = "block";
            ui.sheetContainer.classList.remove('interactive');
            ui.replayBtn.style.display = "none"; 
        }

        updateStats(); nextRound();
    }

    function nextRound() {
        if(gameState.lives <= 0) return;

        // Golden Round Logic check
        gameState.roundsPlayed++;
        if (gameState.roundsPlayed >= gameState.nextGoldenRound) {
            gameState.isGoldenRound = true;
            gameState.nextGoldenRound = gameState.roundsPlayed + Math.floor(Math.random() * 11) + 10; // next in 10-20
            ui.app.classList.add('golden-mode');
            ui.goldenBadge.style.display = "inline-block";
        } else {
            gameState.isGoldenRound = false;
            ui.app.classList.remove('golden-mode');
            ui.goldenBadge.style.display = "none";
        }

        gameState.isAnswering = false; ui.feedback.textContent = ""; ui.interaction.innerHTML = "";
        
        if (gameState.gameType === 'rhythm') {
            gameState.currentNote = generateRhythmNote();
            ui.rhythmImage.src = `img/${gameState.currentNote.file}.webp`;
            renderRhythmButtons();
        } 
        else {
            gameState.currentNote = generateNote();
            if (gameState.gameType === 'read') {
                drawNote(gameState.currentNote, ui);
                ui.noteGroup.style.display = "block";
                setTimeout(() => playTone(getFrequencyForNote(gameState.currentNote), 0.5), 300);
                if (gameState.difficulty === 'hard') renderHardModeInput(); else renderButtons();
            } else {
                ui.noteGroup.style.display = "none"; ui.ledgers.innerHTML = "";
                ui.targetNoteName.textContent = gameState.currentNote.correctName;
                if (gameState.difficulty === 'easy') { ui.placeControls.style.visibility = "hidden"; gameState.selectedPlaceAccidental = 'natural'; }
                else { ui.placeControls.style.visibility = "visible"; selectAccidental('natural'); }
            }
        }
    }

    /* --- GAME LOGIC (CORE) --- */
    function handleCorrectAnswer() {
        gameState.combo++;
        let points = 1;
        if(gameState.combo >= 3) points = 2;
        
        let feedbackAdd = "";

        // Golden Round Bonus
        if (gameState.isGoldenRound) {
            if(gameState.lives < 3) {
                gameState.lives++;
                feedbackAdd = " ‚ù§Ô∏è Leben zur√ºck!";
            } else {
                points += 5; // Bonus points instead of life
                feedbackAdd = " üåü Bonus Punkte!";
            }
        }

        gameState.score += points;
        
        ui.head.style.fill = "var(--success)";
        ui.feedback.textContent = (gameState.combo >= 3 ? `Richtig! üî• x${gameState.combo}` : "Richtig!") + feedbackAdd;
        ui.feedback.style.color = "var(--success)";
        
        playTone(880, 0.1); 
        updateStats();
        setTimeout(nextRound, 1200); // Etwas mehr Zeit um Bonus zu lesen
    }

    function handleWrongAnswer(msg) {
        gameState.combo = 0;
        ui.head.style.fill = "var(--error)";
        ui.feedback.style.color = "var(--error)";
        ui.feedback.textContent = msg;
        
        playTone(150, 0.3);
        
        gameState.lives--;
        updateStats();
        if(gameState.lives <= 0) setTimeout(() => showGameOver(true), 1000);
        else setTimeout(nextRound, 1500);
    }

    /* --- PLACE MODE LOGIC --- */
    function handleStaffClick(event) {
        if (gameState.gameType !== 'place' || gameState.isAnswering) return;

        const snappedY = getSnappedY(event);
        if(snappedY < 20 || snappedY > 190) return;

        gameState.isAnswering = true;
        ui.ghostGroup.style.display = "none";

        let accType = gameState.selectedPlaceAccidental;
        let userAcc = (accType === "sharp") ? "‚ôØ" : (accType === "flat" ? "‚ô≠" : "");
        
        const clickedNoteObj = allBaseNotes.find(n => n.y === snappedY);
        const clickedName = clickedNoteObj ? clickedNoteObj.name : "?";

        const userNote = { base: { y: snappedY, name: clickedName }, acc: { symbol: userAcc, type: accType } };
        drawNote(userNote, ui);
        ui.noteGroup.style.display = "block";

        const targetName = gameState.currentNote.base.name;
        const targetAccType = gameState.currentNote.acc.type;
        
        playTone(getFreqFromYAndAcc(snappedY, accType), 0.5);

        if (clickedName === targetName && accType === targetAccType) {
            handleCorrectAnswer();
        } else {
            let msg = "Falsch!";
            if (clickedName !== targetName) msg += " Falsche Note.";
            else if (accType !== targetAccType) msg += " Falsches Vorzeichen.";
            handleWrongAnswer(msg);
        }
    }

    /* --- READ & RHYTHM MODE LOGIC --- */
    function handleReadAnswer(answer, element) {
        if(gameState.isAnswering) return;
        
        let isCorrect = false;
        // Logic split based on game type
        if (gameState.gameType === 'rhythm') {
            isCorrect = answer === gameState.currentNote.name;
        } else {
            isCorrect = answer.toLowerCase() === gameState.currentNote.correctName.toLowerCase();
        }

        gameState.isAnswering = true;
        
        if (isCorrect) {
            if(element) element.classList.add('correct');
            else { document.getElementById('answer-input').style.borderColor = "var(--success)"; document.getElementById('submit-btn').style.backgroundColor = "var(--success)"; }
            handleCorrectAnswer();
        } else {
            if(element) element.classList.add('wrong');
            else { document.getElementById('answer-input').style.borderColor = "var(--error)"; }
            
            let correctText = gameState.gameType === 'rhythm' ? gameState.currentNote.name : gameState.currentNote.correctName;
            handleWrongAnswer(`Richtig w√§re: ${correctText}`);
        }
    }

    /* --- HELPER --- */
    function selectAccidental(type) {
        gameState.selectedPlaceAccidental = type;
        Object.values(ui.accBtns).forEach(b => b.classList.remove('selected'));
        if(type === 'natural') ui.accBtns.natural.classList.add('selected');
        if(type === 'sharp') ui.accBtns.sharp.classList.add('selected');
        if(type === 'flat') ui.accBtns.flat.classList.add('selected');
    }
    function getSnappedY(event) {
        const rect = ui.staffSvg.getBoundingClientRect();
        const scaleY = 200 / rect.height;
        return Math.round(((event.clientY - rect.top) * scaleY) / 10) * 10;
    }
    function handleStaffMove(event) {
        if(gameState.gameType !== 'place' || gameState.isAnswering) return;
        const y = getSnappedY(event);
        if(y < 20 || y > 190) { ui.ghostGroup.style.display = "none"; return; }
        ui.ghostGroup.style.display = "block";
        ui.ghostHead.setAttribute('cy', y);
        ui.ghostHead.setAttribute('transform', `rotate(-15 110 ${y})`);
        let accSym = (gameState.selectedPlaceAccidental === 'sharp') ? "‚ôØ" : (gameState.selectedPlaceAccidental === 'flat' ? "‚ô≠" : "");
        ui.ghostAcc.textContent = accSym; ui.ghostAcc.setAttribute('y', y);
        ui.ghostLedgers.innerHTML = "";
        if (y >= 160) { for (let ly = 160; ly <= y; ly += 20) addLedgerLine(ly, ui.ghostLedgers, "#6c5ce7"); }
        if (y <= 40) { for (let ly = 40; ly >= y; ly -= 20) addLedgerLine(ly, ui.ghostLedgers, "#6c5ce7"); }
    }
    function handleStaffLeave() { ui.ghostGroup.style.display = "none"; }
    
    /* --- BUTTON RENDERING --- */
    function renderButtons() {
        const isEasy = gameState.difficulty === 'easy';
        const grid = document.createElement('div');
        grid.className = isEasy ? 'options-grid easy-mode' : 'options-grid';
        let pool = isEasy ? ["C", "D", "E", "F", "G", "A", "H"] : ["C", "D", "E", "F", "G", "A", "H", "Cis", "Dis", "Fis", "Gis", "Ais", "Des", "Es", "Ges", "As", "B"];
        let opts = new Set([gameState.currentNote.correctName]);
        while(opts.size < (isEasy ? 4 : 12)) opts.add(pool[Math.floor(Math.random()*pool.length)]);
        Array.from(opts).sort(() => Math.random() - 0.5).forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'game-btn'; btn.textContent = opt;
            btn.onclick = () => handleReadAnswer(opt, btn); grid.appendChild(btn);
        });
        ui.interaction.appendChild(grid);
    }

    function renderRhythmButtons() {
        const grid = document.createElement('div');
        grid.className = 'options-grid rhythm-mode';
        
        let availableOptions = [];
        if (gameState.difficulty === 'hard') {
            availableOptions = rhythmData.map(r => r.name);
        } else {
            availableOptions = rhythmData.filter(r => r.type === 'note').map(r => r.name);
        }
        
        availableOptions.forEach(optName => {
            const btn = document.createElement('button');
            btn.className = 'game-btn'; 
            btn.textContent = optName;
            if(optName.length > 10) btn.style.fontSize = "0.9rem";
            btn.onclick = () => handleReadAnswer(optName, btn); 
            grid.appendChild(btn);
        });
        ui.interaction.appendChild(grid);
    }

    function renderHardModeInput() {
        const wrapper = document.createElement('div'); wrapper.className = 'input-area';
        const input = document.createElement('input'); input.type = "text"; input.id = "answer-input"; input.placeholder = "Note...";
        const submit = document.createElement('button'); submit.id = "submit-btn"; submit.textContent = "OK";
        submit.onclick = () => { if(input.value.trim() !== "") handleReadAnswer(input.value.trim(), null); };
        input.addEventListener("keypress", (e) => { if (e.key === "Enter" && input.value.trim() !== "") handleReadAnswer(input.value.trim(), null); });
        wrapper.appendChild(input); wrapper.appendChild(submit);
        ui.interaction.appendChild(wrapper); setTimeout(() => input.focus(), 50);
    }
    
    function updateStats() {
        let h = ""; for(let i=0; i<gameState.lives; i++) h += "‚ù§";
        ui.lives.textContent = h; 
        ui.score.textContent = gameState.score;
        if(gameState.combo >= 2) {
            ui.combo.textContent = `üî• x${gameState.combo}`;
            ui.combo.classList.add('active');
        } else {
            ui.combo.classList.remove('active');
        }
    }
    function showGameOver(saved) {
        if(saved) {
            fireConfetti();
            let modeName = "Unbekannt";
            if(gameState.gameType === 'read') modeName = "Lesen";
            else if(gameState.gameType === 'place') modeName = "Schreiben";
            else if(gameState.gameType === 'rhythm') modeName = "Rhythmus";

            highscores.push({ date: new Date().toLocaleDateString(), score: gameState.score, mode: modeName, diff: gameState.difficulty });
            highscores.sort((a,b) => b.score - a.score); highscores = highscores.slice(0, 5);
            localStorage.setItem('musicScores', JSON.stringify(highscores));
        }
        ui.finalScore.textContent = gameState.score; ui.overlayTitle.textContent = saved ? "Verloren!" : "Beendet"; ui.overlay.classList.add('visible');
    }
    function updateHighscoreList() {
        ui.scoreList.innerHTML = ""; if(highscores.length === 0) ui.scoreList.innerHTML = "<li>Noch keine Spiele gespielt!</li>";
        highscores.forEach(s => { const li = document.createElement('li'); li.style.padding = "10px"; li.style.borderBottom = "1px solid #ddd"; li.innerHTML = `<strong>${s.score}</strong> (${s.mode} - ${s.diff})`; ui.scoreList.appendChild(li); });
    }

    /* --- BASIC HELPERS --- */
    function getNoteName(base, type) { if(type === "natural") return base; if(type === "sharp") return base + "is"; if(base === "H") return "B"; if(base === "E") return "Es"; if(base === "A") return "As"; return base + "es"; }
    
    function generateNote() {
        let pool = allBaseNotes;
        if (gameState.difficulty === 'easy') pool = allBaseNotes.filter(n => n.y >= 50 && n.y <= 160);
        
        let newNote;
        do {
            const base = pool[Math.floor(Math.random() * pool.length)];
            let acc = accidentals[0];
            if (gameState.difficulty !== 'easy' && Math.random() > 0.6) acc = Math.random() > 0.5 ? accidentals[1] : accidentals[2];
            newNote = { base: base, acc: acc, correctName: getNoteName(base.name, acc.type) };
        } while (gameState.currentNote && newNote.correctName === gameState.currentNote.correctName);
        
        return newNote;
    }

    function generateRhythmNote() {
        let pool = [];
        if (gameState.difficulty === 'hard') {
            pool = rhythmData; 
        } else {
            pool = rhythmData.filter(item => item.type === 'note'); 
        }
        
        let newItem;
        do {
            newItem = pool[Math.floor(Math.random() * pool.length)];
        } while (gameState.currentNote && newItem.name === gameState.currentNote.name);
        
        return newItem;
    }

    function drawNote(note, targetUi) {
        const y = note.base.y; targetUi.head.setAttribute('cy', y); targetUi.head.setAttribute('transform', `rotate(-15 110 ${y})`);
        targetUi.head.style.fill = "#2d3436";
        if (note.acc.symbol !== "") { targetUi.acc.style.display = "block"; targetUi.acc.textContent = note.acc.symbol; targetUi.acc.setAttribute('y', y); }
        else { targetUi.acc.style.display = "none"; }
        if (y >= 100) { targetUi.stem.setAttribute('y1', y); targetUi.stem.setAttribute('y2', y - 35); }
        else { targetUi.stem.setAttribute('y1', y); targetUi.stem.setAttribute('y2', y + 35); }
        targetUi.ledgers.innerHTML = "";
        if (y >= 160) { for (let ly = 160; ly <= y; ly += 20) addLedgerLine(ly, targetUi.ledgers); }
        if (y <= 40) { for (let ly = 40; ly >= y; ly -= 20) addLedgerLine(ly, targetUi.ledgers); }
    }
    function addLedgerLine(y, container, color="#2d3436") {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", 85); line.setAttribute("x2", 135); line.setAttribute("y1", y); line.setAttribute("y2", y);
        line.setAttribute("stroke", color); line.setAttribute("stroke-width", "2"); container.appendChild(line);
    }
    function getFrequencyForNote(noteObj) { return getFreqFromYAndAcc(noteObj.base.y, noteObj.acc.type); }
    function getFreqFromYAndAcc(y, accType) {
        const yMap = { 190: 196.00, 180: 220.00, 170: 246.94, 160: 261.63, 150: 293.66, 140: 329.63, 130: 349.23, 120: 392.00, 110: 440.00, 100: 493.88, 90: 523.25, 80: 587.33, 70: 659.25, 60: 698.46, 50: 783.99, 40: 880.00, 30: 987.77, 20: 1046.50 };
        let f = yMap[y] || 440; if(accType === "sharp") f *= 1.05946; if(accType === "flat") f /= 1.05946; return f;
    }

    /* --- CONFETTI EFFECT --- */
    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                vx: Math.random() * 4 - 2, vy: Math.random() * 5 + 2,
                color: `hsl(${Math.random()*360}, 100%, 50%)`, size: Math.random() * 8 + 4
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let active = false;
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if(p.y < canvas.height) {
                    active = true;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);
                }
            });
            if(active) requestAnimationFrame(animate);
            else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        animate();
    }

    /* --- PIANO --- */
    function initPiano() {
        const container = document.getElementById('piano-keyboard'); container.innerHTML = "";
        const keys = [ { n: "C", oct: 4, type: "white", y: 160 }, { n: "C#", oct: 4, type: "black", ref: "C", y: 160 }, { n: "D", oct: 4, type: "white", y: 150 }, { n: "D#", oct: 4, type: "black", ref: "D", y: 150 }, { n: "E", oct: 4, type: "white", y: 140 }, { n: "F", oct: 4, type: "white", y: 130 }, { n: "F#", oct: 4, type: "black", ref: "F", y: 130 }, { n: "G", oct: 4, type: "white", y: 120 }, { n: "G#", oct: 4, type: "black", ref: "G", y: 120 }, { n: "A", oct: 4, type: "white", y: 110 }, { n: "A#", oct: 4, type: "black", ref: "A", y: 110 }, { n: "H", oct: 4, type: "white", y: 100 }, { n: "C", oct: 5, type: "white", y: 90 }, { n: "C#", oct: 5, type: "black", ref: "C5", y: 90 }, { n: "D", oct: 5, type: "white", y: 80 }, { n: "D#", oct: 5, type: "black", ref: "D5", y: 80 }, { n: "E", oct: 5, type: "white", y: 70 }, { n: "F", oct: 5, type: "white", y: 60 }, { n: "F#", oct: 5, type: "black", ref: "F5", y: 60 }, { n: "G", oct: 5, type: "white", y: 50 }, { n: "G#", oct: 5, type: "black", ref: "G5", y: 50 }, { n: "A", oct: 5, type: "white", y: 40 }, { n: "A#", oct: 5, type: "black", ref: "A5", y: 40 }, { n: "H", oct: 5, type: "white", y: 30 } ];
        let whiteCount = 0;
        keys.forEach(k => {
            const btn = document.createElement('div'); btn.className = `key ${k.type}`;
            if (k.type === "white") { container.appendChild(btn); whiteCount++; } else { let prevWhites = keys.filter(x => x.type === 'white' && keys.indexOf(x) < keys.indexOf(k)).length; let leftPos = (prevWhites * 44) - 16; btn.style.left = leftPos + "px"; container.appendChild(btn); }
            btn.onmousedown = () => { btn.classList.add('active'); playPianoNote(k); }; btn.onmouseup = () => btn.classList.remove('active'); btn.onmouseleave = () => btn.classList.remove('active');
        });
        container.style.width = (whiteCount * 44) + "px";
    }
    function playPianoNote(keyData) {
        let f = getFreqFromYAndAcc(keyData.y, keyData.n.includes("#") ? "sharp" : "natural"); playTone(f);
        ui.pGroup.style.display = "block"; const y = keyData.y; ui.pHead.setAttribute('cy', y); ui.pHead.setAttribute('transform', `rotate(-15 110 ${y})`);
        if (y >= 100) { ui.pStem.setAttribute('y1', y); ui.pStem.setAttribute('y2', y - 35); } else { ui.pStem.setAttribute('y1', y); ui.pStem.setAttribute('y2', y + 35); }
        if (keyData.n.includes("#")) { ui.pAcc.style.display = "block"; ui.pAcc.textContent = "‚ôØ"; ui.pAcc.setAttribute('y', y); } else { ui.pAcc.style.display = "none"; }
        ui.pLedgers.innerHTML = ""; if (y >= 160) { for (let ly = 160; ly <= y; ly += 20) addLedgerLine(ly, ui.pLedgers); } if (y <= 40) { for (let ly = 40; ly >= y; ly -= 20) addLedgerLine(ly, ui.pLedgers); }
        let name = keyData.n.replace("#", "is"); if(keyData.oct === 5) name += "'"; ui.pName.textContent = name;
    }
</script>
</body>
</html>